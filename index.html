<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="yndongyong‘s blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="记录学习的点滴">
<meta property="og:type" content="website">
<meta property="og:title" content="yndongyong‘s blog">
<meta property="og:url" content="https://yndongyong.github.io/index.html">
<meta property="og:site_name" content="yndongyong‘s blog">
<meta property="og:description" content="记录学习的点滴">
<meta property="og:locale">
<meta property="article:author" content="yndongyong">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yndongyong.github.io/"/>





  <title>yndongyong‘s blog</title>
  














<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yndongyong‘s blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生命不息，学习不止！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-about"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2018/08/30/%E4%BD%BF%E7%94%A8NON-UI%E2%80%94FRAGMENT%E4%BC%98%E5%8C%96startActivityForResult%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/30/%E4%BD%BF%E7%94%A8NON-UI%E2%80%94FRAGMENT%E4%BC%98%E5%8C%96startActivityForResult%E4%BB%A3%E7%A0%81/" itemprop="url">使用NON-UI—FRAGMENT优化startActivityForResult代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-30T10:30:58+08:00">
                2018-08-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用NON-UI-FRAGMENT优化startActivityForResult"><a href="#使用NON-UI-FRAGMENT优化startActivityForResult" class="headerlink" title="使用NON-UI-FRAGMENT优化startActivityForResult"></a>使用NON-UI-FRAGMENT优化startActivityForResult</h2><p>一般地，要使用AActivity.startActivityForResult(BActivity)需要在Activity中覆盖父类的onActivityForResult（）回调方法。</p>
<p>如果一个Activity需要调用多个Activity并且获取返回结果，会造成调用处和回调处彼此分离，逻辑不清晰、代码混乱的的问题。有没有一种较为优雅的方式，打破这种惯性。</p>
<p>回答是肯定的，即本文的NON-UI-FRAGMENT，使用无UI的fragment，将部分业务代码封装到fragment中，再通过callback将最终结果回调给Activity，原本的Activity再也不用复写父类的startActivityForResult，传递一个回调即可。</p>
<p>使用这种方式，可以封装那些共性较多的类，将原本需要通过继承和复写的逻辑放到fragment中，体现了软件开发中的一大设计原则——使用组合替代继承。</p>
<p>本文中的startActivityForResult的替代优化仅是NON-UI-FRAGMENT的一种实现使用，NON-UI-FRAGMENT的可以做的更多，一些简单的使用场景：譬如封装权限申请、登录判断跳转，第三方登录等、截屏等等，其他待自己拓展。</p>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><pre><code>ActivityResultHelper resultHelper = ActivityResultHelper.attach(this);
resultHelper.startForResult(intent, 0x10, new ActivityResultHelper.CallBack() &#123;
    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) &#123;
        if (requestCode == 101 &amp;&amp; resultCode == RESULT_OK) &#123;
            Log.d(&quot;DONG&quot;, &quot;true&quot;);
        &#125; else &#123;
            Log.d(&quot;DONG&quot;, &quot;false&quot;);
        &#125;
    &#125;
&#125;);
</code></pre>
<p>再也不用将调用入口和返回结果处理的代码分开了。 </p>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><pre><code> public class ActivityResultHelper extends Fragment &#123;

    private static final String FRAG_TAG = ActivityResultHelper.class.getCanonicalName();

    private Activity mContext;

    private CallBack mListener;

    public interface CallBack &#123;
        void onActivityResult(int requestCode, int resultCode, Intent data);
    &#125;

    public static &lt;ParentFrag extends Fragment&gt; ActivityResultHelper attach(ParentFrag parent) &#123;
        return attach(parent.getChildFragmentManager());
    &#125;

    public static &lt;ParentActivity extends FragmentActivity&gt; ActivityResultHelper attach(ParentActivity parent) &#123;
        return attach(parent.getSupportFragmentManager());
    &#125;

    private static ActivityResultHelper attach(FragmentManager fragmentManager) &#123;
        ActivityResultHelper frag = (ActivityResultHelper) fragmentManager.findFragmentByTag(FRAG_TAG);
        if (frag == null) &#123;
            frag = new ActivityResultHelper();
            fragmentManager.beginTransaction().add(frag, FRAG_TAG).commit();
            //TODO fragment在Activity的onCreate中被attach之后就立即调用fragment的一些方法，需要如下代码，否则不需要
            fragmentManager.executePendingTransactions();
        &#125;
        return frag;
    &#125;

    @Override
    public void onAttach(Context context) &#123;
        super.onAttach(context);
        mContext = (Activity) context;
    &#125;

    @Override
    public void onDetach() &#123;
        super.onDetach();
        mContext = null;
    &#125;

    public Activity getContext() &#123;
        return mContext;
    &#125;

    public void startForResult(Intent intent, int requestCode, CallBack listener) &#123;
        this.mListener = listener;
        startActivityForResult(intent, requestCode);
    &#125;

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) &#123;
        if (mListener != null) &#123;
            mListener.onActivityResult(requestCode, resultCode, data);
        &#125;
    &#125;
&#125;      
    
</code></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2018/08/01/Android%E8%87%AA%E5%AE%9A%E4%B9%89View%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD%E5%BC%95%E5%AF%BC%E9%A1%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/01/Android%E8%87%AA%E5%AE%9A%E4%B9%89View%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD%E5%BC%95%E5%AF%BC%E9%A1%B5/" itemprop="url">Android自定义View实现功能引导页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-01T16:43:28+08:00">
                2018-08-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="库地址"><a href="#库地址" class="headerlink" title="库地址"></a><a target="_blank" rel="noopener" href="https://github.com/yndongyong/GuideView">库地址</a></h3><p><a target="_blank" rel="noopener" href="https://github.com/yndongyong/GuideView/blob/master/dest/app_guideview-debug.apk">demo</a></p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>实现页面引导，提示用户操作。用户引导结合场景，以图层的形式叠加到对应的View上。高亮效果支持矩形、圆角矩形、圆形、椭圆四种形状，以及支持高斯模糊的效果。</p>
<p>效果预览图</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/18-8-1/91135939.jpg" alt="功能引导"></p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ol>
<li>使用自定义view实现，显示时机控制为界面绘制完成后的下一个帧</li>
<li>以图层的形式叠加到UI控件上</li>
<li>高亮效果支持矩形、圆角矩形、圆形、椭圆四种</li>
<li>支持高斯模糊效果</li>
<li>提示布局方向支持左、上、右、下四个方向的居中，支持扩展</li>
<li>支持全部一起显示，或是一个接一个的显示方式</li>
</ol>
<h3 id="changelog"><a href="#changelog" class="headerlink" title="changelog"></a>changelog</h3><p><strong>v0.0.1</strong></p>
<p>实现效果，可用</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol start="0">
<li>收集要高亮显示的view的左上点坐标、宽高信息</li>
<li>取到Activity的decorview，添加一层FrameLayout布局</li>
<li>自定义view(GuideView)中根据高亮显示的view的坐标宽高信息，使用PorterDuffXfermode 的Mode.XOR，画出镂空效果，同一个坐标上正常的画一次，Mode.XOR的模式绘制第二次即可以实现镂空的效果</li>
<li>在GuideView中根据高亮view的坐标 addView（功能提示的view），代码中处理了addView 以及requestLayout之后布局会闪烁的问题。</li>
</ol>
<p>PorterDuffXfermode 的Mode.XOR 原理参见：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2041548-d964105abf4be5d9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/312" alt="图像合成"></p>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">new GuideViewHelper.Builder()</span><br><span class="line">      .addView(id_switch_1, new BottomCenterItemDecoration(R.layout.item_decoration_0))</span><br><span class="line">      .padding(5)</span><br><span class="line">      .setHighLightShape(HighLightShape.TYPE_CIRCULAR)</span><br><span class="line">      .showAll(true)</span><br><span class="line">      .build()</span><br><span class="line">      .show(this);</span><br><span class="line">                </span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：支持直接onCreate方法中调用show方法</p>
</blockquote>
<h4 id="1、提供的对齐方式"><a href="#1、提供的对齐方式" class="headerlink" title="1、提供的对齐方式"></a>1、提供的对齐方式</h4><p>提示布局方向支持左、上、右、下四个方向上的居中对齐显示</p>
<p>显示在左边与高亮view在水平方向居中对齐</p>
<p><code>LeftCenterItemDecoration</code></p>
<p>显示在上方与高亮view在垂直方向居中对齐</p>
<p><code>TopCenterItemDecoration</code></p>
<p>显示在右方与高亮view在水平方向居中对齐</p>
<p><code>RightCenterItemDecoration</code></p>
<p>显示在下方与高亮view在垂直方向居中对齐</p>
<p><code>BottomCenterItemDecoration</code></p>
<h4 id="2、-扩展对齐方式"><a href="#2、-扩展对齐方式" class="headerlink" title="2、 扩展对齐方式"></a>2、 扩展对齐方式</h4><p>提供的对齐方式若不满足需求，可以继承ItemDecoration扩展，实现如下的方法：</p>
<p><code>public abstract int[] getOffsetLeftAndTop(CutoutViewInfo cutoutViewInfo, int offsetX, int offsetY);</code></p>
<p>该方法返回一个int[] 数组，存放功能提示view的left 和 top 坐标</p>
<h4 id="5、暴露的回调方法-OnGuideViewDismissListener"><a href="#5、暴露的回调方法-OnGuideViewDismissListener" class="headerlink" title="5、暴露的回调方法 OnGuideViewDismissListener"></a>5、暴露的回调方法 OnGuideViewDismissListener</h4><p>回调时机：当功能提示view全部显示完关闭时</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">guideViewHelper.show(MainActivity.this, new GuideView.OnGuideViewDismissListener() &#123;</span><br><span class="line">                   @Override</span><br><span class="line">                   public void onDisMiss() &#123;</span><br><span class="line">                       Toast.makeText(MainActivity.this, &quot;guide view dismiss&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2018/06/03/RecyclerView-%E9%80%9A%E7%94%A8Adapter%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E5%B8%83%E5%B1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/03/RecyclerView-%E9%80%9A%E7%94%A8Adapter%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E5%B8%83%E5%B1%80/" itemprop="url">RecyclerView 通用Adapter支持多种布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-03T12:43:16+08:00">
                2018-06-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>库地址：<a target="_blank" rel="noopener" href="https://github.com/yndongyong/multiitemview/tree/ontomany_0.0.3">https://github.com/yndongyong/multiitemview/tree/ontomany_0.0.3</a></p>
<p>作用：简化adapter中涉及多种ItemView布局的写法，使用对象池存放布局对象(ItemViewProvider)，每一个布局委托一个ItemViewProvider，并在其中封装布局与对象绑定相关的逻辑，简化Adapter。</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>极少的类文件</li>
<li>简化Adapter的写法，直接使用SimpleAdapter</li>
<li>支持多种布局类型，扩展方便</li>
<li>每一种布局相关逻辑均写在对应的委托类中</li>
<li>支持一种数据类型对应多种布局</li>
</ul>
<h3 id="主要涉及的类"><a href="#主要涉及的类" class="headerlink" title="主要涉及的类"></a>主要涉及的类</h3><h4 id="SimpleAdapter"><a href="#SimpleAdapter" class="headerlink" title="SimpleAdapter"></a>SimpleAdapter</h4><p>继承RecylerView的adapter，简化多类型Item的Adapter写法。</p>
<h4 id="ItemViewProvider"><a href="#ItemViewProvider" class="headerlink" title="ItemViewProvider"></a>ItemViewProvider</h4><p>针对每一种布局Item的委托类，onCreateViewHolder和onBindViewHolder都由其委托，在其中完成布局的解析和对象的绑定和该布局相关的逻辑，向外暴露两个方法，一个是返回布局id,一个用于ViewHolder和实体对象的绑定。</p>
<pre><code>int getLayoutId()//布局文件id
void onBindViewHolder(SimpleViewHolder holder, T entity);//绑定UI和值
</code></pre>
<h4 id="Items"><a href="#Items" class="headerlink" title="Items"></a>Items</h4><p>用于存放数据集</p>
<h3 id="实现思想"><a href="#实现思想" class="headerlink" title="实现思想"></a>实现思想</h3><ul>
<li>使用一个SparseArray来保存viewType(即是getItemViewType的返回值)和ItemViewProvider的对应关系</li>
<li>使用一个SparseArray来保存viewType和Model（实体类型）的对应关系</li>
</ul>
<p>对应关系举例如下表所示：</p>
<table>
<thead>
<tr>
<th align="center">viewType</th>
<th align="center">Model</th>
<th align="left">ItemViewProvider</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">Category</td>
<td align="left">CategoryStyle1ItemViewProvider</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">News</td>
<td align="left">NewsItemViewProvider</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">Category</td>
<td align="left">CategoryStyle2ItemViewProvider</td>
</tr>
</tbody></table>
<p>Adapter的getItemViewType方法的思路举例如下：</p>
<p>对应的实体类型是News，先找到他的viewType，为1，在通过viewType找到对应的ItemViewProvider,对应的ItemViewProvider只有一个，getItemViewType则立即放回ViewType</p>
<p>对应的实体类型是Category，先找到他的viewType为0，2，再通过viewType找到的对应的ItemViewViewProvider为多个，最终通过ItemViewProvider的accept方法判断由哪个具体的ItemViewViewProvider处理，最中返回其viewType的值。 </p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><pre><code>//准备数据
 items.add(&quot;头部1 -- type1&quot;);
items.add(new CategoryEntry(&quot;http://pic.58pic.com/58pic/14/27/45/71r58PICmDM_1024.jpg&quot;, &quot;风景图片1&quot;));
items.add(new CategoryEntry(&quot;http://img0.imgtn.bdimg.com/it/u=1610953019,3012342313&amp;fm=214&amp;gp=0.jpg&quot;, &quot;风景图片2&quot;));

items.add(&quot;头部2 -- type2&quot;);
items.add(new CategoryEntry(&quot;http://pic.58pic.com/58pic/14/27/45/71r58PICmDM_1024.jpg&quot;, &quot;风景图片4&quot;, 2));
items.add(new CategoryEntry(&quot;http://img0.imgtn.bdimg.com/it/u=1610953019,3012342313&amp;fm=214&amp;gp=0.jpg&quot;, &quot;风景图片5&quot;, 2));

multiTypeAdapter = SimpleAdapter.create(this)
            .addNewData(items)
            .register(new HeaderItemViewProvider())
            .register(new Category1EntryItemViewProvider())
            .register(new Category2EntryItemViewProvider())
            .register(new Category3EntryItemViewProvider())
            .attachToRecyclerView(rv_list);
</code></pre>
<p>效果图中一共实现了4中布局类型：</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/18-6-3/25785972.jpg" alt="多种布局"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2018/01/27/%E4%BD%BF%E7%94%A8RecyclerView%E5%AE%9E%E7%8E%B0%E5%88%86%E7%BB%84%E7%9A%84%E5%B1%95%E5%BC%80%E4%B8%8E%E6%94%B6%E7%BC%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/27/%E4%BD%BF%E7%94%A8RecyclerView%E5%AE%9E%E7%8E%B0%E5%88%86%E7%BB%84%E7%9A%84%E5%B1%95%E5%BC%80%E4%B8%8E%E6%94%B6%E7%BC%A9/" itemprop="url">使用RecyclerView实现分组的展开与收缩</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-27T18:05:12+08:00">
                2018-01-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用RecyclerView实现分组的折叠和展开的显示效果，先上效果图：<br><img src="http://oav23hfp9.bkt.clouddn.com/18-5-7/87674041.jpg" alt="效果图"></p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>如图中所示，有多个Section，每个Section对应着一组数据。可以直接点击Section或者Section的箭头来展开显示当前Section下的数据，或者收起当前Section。项目中使用RecyclerView实现这种效果。主要的思路是：使用两种viewtype实现对应的Section和下层的Entity布局，当展开和折叠操作触发时动态计算RecyclerView对应的Adapter应该包含的数据集，该数据集包含Section数据集和Entity数据集，之后再触犯RecyclerView刷新。</p>
<p>Adapter的数据集计算规则如下举例:</p>
<ul>
<li>Section都是折叠效果的时，Adapter对应的数据集是：list.addAll(所有Section)</li>
<li>第一个Section展开时的Adapter对应的数据集是：list.add(第一个Setction),list.addAll(第一个Section下的Entity数据集),list.add(其他Section)</li>
</ul>
<p> </p>
<p> <br>定义Section实体</p>
<pre><code>public class Section &#123;

    private String id;

    //title
    private String name;
    //subtitle
    private String subTitle;
    //Section是否是展开状态 true：展开
    private boolean isExpanded;

        &lt;!--其他属性和getter/setter方法--&gt;
&#125; 
</code></pre>
<p>定义第二层的实体ProgramEntity</p>
<pre><code>public class ProgramEntity &#123;

    private String id;
    private String name;
    private String abumId;
    private String content;
    &lt;!--其他属性和getter/setter方法--&gt;

&#125;
</code></pre>
<p>项目中的使用的Adapter是之前的封装的Adapter,其思想同代码家的MultiType</p>
<p>在Adapter中为项目注册类型和布局提供者的关系</p>
<pre><code>mSectionedExpandableGridAdapter = new ExpandableGridAdapter(context, mDataArrayList);
&lt;!--对应Section布局--&gt;
    mSectionedExpandableGridAdapter.register(Section.class, new SectionItemViewProvider(sectionStateChangeListener));
&lt;!--对应Entity布局--&gt;
    ProgramStyle2ItemViewProvider programStyle2ItemViewProvider
            = new ProgramStyle2ItemViewProvider();
    mSectionedExpandableGridAdapter.register(ProgramEntity.class, programStyle2ItemViewProvider);
    recyclerView.setAdapter(mSectionedExpandableGridAdapter);
    
</code></pre>
<p>当Section被点击是时会回调SectionStateChangeListener，在回调方法中重新计算Adapter数据集中应包含的数据，在触发Recyclerview的刷新。</p>
<p>核心代码</p>
<pre><code>//data list
private LinkedHashMap&lt;Section, List&lt;ProgramEntity&gt;&gt; mSectionDataMap = new LinkedHashMap&lt;Section, List&lt;ProgramEntity&gt;&gt;();
private Items mDataArrayList = new Items();

public void notifyDataSetChanged() &#123;
    //先清空原本的数据
    mDataArrayList.clear();
    for (Map.Entry&lt;Section, List&lt;ProgramEntity&gt;&gt; entry : mSectionDataMap.entrySet()) &#123;
        Section key;
        //将Section添加到数据容器中
        mDataArrayList.add((key = entry.getKey()));
        //Section是展开状态将Section对应的Entity数据集添加到数据容器中
        if (key.isExpanded())
            mDataArrayList.addAll(entry.getValue());
    &#125;
    mSectionedExpandableGridAdapter.notifyDataSetChanged();
&#125;
      
</code></pre>
<p>如果Section下的数据展示是多列，Recyclerview还可以使用GridLayoutManager，通过SpanSizeLookup控制Section单独显示一行，而二层数据显示为多列。</p>
<pre><code>gridLayoutManager.setSpanSizeLookup(new GridLayoutManager.SpanSizeLookup() &#123;
        @Override
        public int getSpanSize(int i) &#123;
            return !isSection(i)?gridLayoutManager.getSpanCount():1;
        &#125;
    &#125;);
    
</code></pre>
<p>如图所示的效果，仅为演示，UI就不再单独处理。</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/18-5-7/15510048.jpg" alt="Section单独占一行，二级为gride的效果图"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2018/01/11/%E4%BD%BF%E7%94%A8Behavior%E5%AE%9E%E7%8E%B0Toolbar%E7%9A%84%E9%80%8F%E6%98%8E%E5%BA%A6%E8%B7%9F%E9%9A%8F%E9%A1%B5%E9%9D%A2%E6%BB%91%E5%8A%A8%E8%BF%9B%E8%A1%8C%E5%8F%98%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/11/%E4%BD%BF%E7%94%A8Behavior%E5%AE%9E%E7%8E%B0Toolbar%E7%9A%84%E9%80%8F%E6%98%8E%E5%BA%A6%E8%B7%9F%E9%9A%8F%E9%A1%B5%E9%9D%A2%E6%BB%91%E5%8A%A8%E8%BF%9B%E8%A1%8C%E5%8F%98%E6%8D%A2/" itemprop="url">使用Behavior实现Toolbar的透明度跟随页面滑动进行变换</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-11T16:43:07+08:00">
                2018-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用Behavior实现Toolbar的透明度跟随页面上下滑动从不透明到透明以及反向的一个显示效果，如下图：</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/18-4-27/40610293.jpg" alt="`Toobar`的显示与隐藏"></p>
<p>###一、实现的效果</p>
<ol>
<li>界面上滑过程中，Toolbar逐渐显示出来，直到完全显示</li>
<li>界面下滑过程中，Toolbar逐渐隐藏，直到完全不可见</li>
</ol>
<p>###二、常规思路</p>
<p>如图所示的效果，常规的做法是为AppBarLayout添加一个OnOffsetChangedListener来监听appbarlayout的滑动的过程，用当前滑动的距离和slideDistance某个固定值计算一个比例，比如图中红色背景块作为锚点，slideDistance就是这个view的高度，通过比例计算出当前的Toolbar的背景颜色的透明值。</p>
<p>1.上滑过程中滑动距离从 0 到 slideDistance 变化，背景颜色根据滑动距离百分比改变颜色透明度，这个过程颜色透明度从 0 到 255。</p>
<p>2.下滑过程：即上滑过程的逆向。</p>
<p>通常情况下，slideDistance 是某个UI元素的高度，这个高度还需要动态的拿到。一般的做法是在Activity的onCreated方法中使用View.post(runnable),或者添加个一个addOnGlobalLayoutListener监听器待界面绘制完成后得到view的高度。</p>
<p>OnOffsetChangedListener的核心代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AppBarLayout.OnOffsetChangedListener offsetChangedListener = new AppBarLayout.OnOffsetChangedListener() &#123;</span><br><span class="line">        @RequiresApi(api = Build.VERSION_CODES.M)</span><br><span class="line">        @Override</span><br><span class="line">        public void onOffsetChanged(AppBarLayout appBarLayout, int verticalOffset) &#123;</span><br><span class="line">            float fraction = Math.abs(verticalOffset * 1.0f) / slideDistance;</span><br><span class="line">            fraction = Math.min(fraction, 1);</span><br><span class="line">            bgColor = changeAlpha(getResources().getColor(R.color.white), fraction);</span><br><span class="line">            header_toolbar.setBackgroundColor(bgColor);</span><br><span class="line">            tv_toolbar_title.setAlpha(fraction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、优化后的思路"><a href="#三、优化后的思路" class="headerlink" title="三、优化后的思路"></a>三、优化后的思路</h3><p>由于项目中的多个详情界面都需要实现这样的效果，造成了代码的多次拷贝，如果将来UI需要改变的话，散落在项目各个角落的代码也将难以维护。此外，在每个界面中Toobar显示隐藏参考的view元素也不同的。</p>
<p>基于以上这些缺点项目最终废弃了常规的做法，使用AppBarLayout.Behavior将这一效果封装、抽象。<br>在需要使用的地方直接引用自定义的Behavior就行。通过Behavior，以一种非侵入的方式为view添加<br>行为。</p>
<p>核心代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ChangeToolbarAlphaBehavior extends AppBarLayout.Behavior &#123;</span><br><span class="line"></span><br><span class="line">    //锚点view</span><br><span class="line">    private static final String TAG_ANCHOR_VIEW = &quot;anchorView&quot;;</span><br><span class="line">    //title</span><br><span class="line">    private static final String TAG_TOOLBAR_TITLE = &quot;toolbarTitle&quot;;</span><br><span class="line">    //toolbar</span><br><span class="line">    private static final String TAG_TOOLBAR = &quot;toolbar&quot;;</span><br><span class="line"></span><br><span class="line">    private TextView header_title;</span><br><span class="line">    private View anchorView;</span><br><span class="line">    private android.support.v7.widget.Toolbar toolbar;</span><br><span class="line"></span><br><span class="line">    float slideDistance = 0f;</span><br><span class="line"></span><br><span class="line">    private int bgColor;</span><br><span class="line"></span><br><span class="line">    private int mainColor = 0;</span><br><span class="line"></span><br><span class="line">    public ChangeToolbarAlphaBehavior(Context context, AttributeSet attrs) &#123;</span><br><span class="line">        super(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * AppBarLayout布局时调用</span><br><span class="line">     * @param parent</span><br><span class="line">     * @param abl</span><br><span class="line">     * @param layoutDirection</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public boolean onLayoutChild(CoordinatorLayout parent, AppBarLayout abl, int layoutDirection) &#123;</span><br><span class="line"></span><br><span class="line">        //拿到toolbar</span><br><span class="line">        if (toolbar == null) &#123;</span><br><span class="line">            toolbar = parent.findViewWithTag(TAG_TOOLBAR);</span><br><span class="line">        &#125;</span><br><span class="line">        //拿到title</span><br><span class="line">        if (header_title == null) &#123;</span><br><span class="line">            header_title = parent.findViewWithTag(TAG_TOOLBAR_TITLE);</span><br><span class="line">        &#125;</span><br><span class="line">        //拿到锚点View，以锚点view的高度作为完全显示或者隐藏的临界值</span><br><span class="line">        if (anchorView == null) &#123;</span><br><span class="line">            anchorView = parent.findViewWithTag(TAG_ANCHOR_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        if (anchorView == null || toolbar == null) &#123;</span><br><span class="line">            return super.onLayoutChild(parent, abl, layoutDirection);</span><br><span class="line">        &#125;</span><br><span class="line">        //临界值</span><br><span class="line">        if (slideDistance == 0f) &#123;</span><br><span class="line">            slideDistance = anchorView.getBottom() - toolbar.getHeight();</span><br><span class="line">        &#125;</span><br><span class="line">        if (mainColor == 0) &#123;</span><br><span class="line">            mainColor = ContextCompat.getColor(parent.getContext(), R.color.white);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        abl.addOnOffsetChangedListener(new AppBarLayout.OnOffsetChangedListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onOffsetChanged(AppBarLayout appBarLayout, int verticalOffset) &#123;</span><br><span class="line">                float fraction = Math.abs(verticalOffset * 1.0f) / slideDistance;</span><br><span class="line">                fraction = Math.min(fraction, 1);</span><br><span class="line"></span><br><span class="line">                bgColor = changeAlpha(mainColor, fraction);</span><br><span class="line">                toolbar.setBackgroundColor(bgColor);</span><br><span class="line">                header_title.setAlpha(fraction);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        return super.onLayoutChild(parent, abl, layoutDirection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据百分比改变颜色透明度</span><br><span class="line">     */</span><br><span class="line">    public int changeAlpha(int color, float fraction) &#123;</span><br><span class="line">        int red = Color.red(color);</span><br><span class="line">        int green = Color.green(color);</span><br><span class="line">        int blue = Color.blue(color);</span><br><span class="line">        int alpha = (int) (Color.alpha(color) * fraction);</span><br><span class="line">        return Color.argb(alpha, red, green, blue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用方式</p>
<p>1、直接在xml里为AppbarLayout添加自定义的behavior</p>
<p><code>app:layout_behavior=&quot;packagename.ChangeToolbarAlphaBehavior&quot;</code></p>
<p>2、为toolbar添加tag</p>
<p><code>android:tag=&quot;toolbar&quot;</code></p>
<p>3、 为锚点view添加tag</p>
<p><code>android:tag=&quot;anchorView&quot;</code></p>
<p>3、 为toolbar中有相同动作的view添加tag</p>
<p>比如此处的title<br><code>android:tag=&quot;toolbarTitle&quot;</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2017/12/17/iOS%E5%BA%94%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%B0%8F%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/17/iOS%E5%BA%94%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%B0%8F%E8%8A%82/" itemprop="url">iOS应用生命周期小节</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-17T13:13:27+08:00">
                2017-12-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="iOS生命周期状态"><a href="#iOS生命周期状态" class="headerlink" title="iOS生命周期状态"></a>iOS生命周期状态</h3><p>iOS应用的生命周期状态分为如下几种：</p>
<ul>
<li>Not Running （非运行状态） 应用尚未运行或者被系统终止</li>
<li>Inactive （前台非运行状态） 应用正在进入前台状态，还不能接受事件处理</li>
<li>Active (前台运行状态) 应用进入前台运行状态，可以接受用户事件处理</li>
<li>Background （后台运行状态） 应用进入后台，依然能够执行代码。执行完之后将进入挂起状态</li>
<li>Suspended（挂起状态） 被挂起的应用进入一种“冷冻状态” ，不能执行代码，若系统内存不足，应用会被终止。</li>
</ul>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-12-17/35088222.jpg" alt="iOS应用的5中状态"></p>
<p>在iOS应用的各种状态转换的过程中，iOS系统会回调应用程序的委托对象AppDelegate中的方法，并且能够发送相应的通知。主要的方法和通知如下：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>通知</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>application:didFinishLaunchingWithOptions:</td>
<td>UIApplicationDidFinishLaunchingNotification</td>
<td>应用启动初始化时会调用该方法并发出通知，这个阶段会实例化根视图控制器</td>
</tr>
<tr>
<td>applictaionDidBecomeActive:</td>
<td>UIApplicationDidBecomeActiveNotification</td>
<td>应用进入前台并且出去活动状态时调用该方法并发出通知，可以在这个方法里恢复UI的状态</td>
</tr>
<tr>
<td>applicationWillResignActive：</td>
<td>UIApplicationWillResignActiveNotification</td>
<td>应用从活动状态进入到非活动状态是调用该方法并发出通知。可以在这个方法里保存UI状态</td>
</tr>
<tr>
<td>applicationDidEnterBackground:</td>
<td>UIApplicationDidEnterBackgroundNotification</td>
<td>应用进入后台时调用该方法并发出通知，可以在这里保存用户数据，释放资源如数据库资源</td>
</tr>
<tr>
<td>applicationWillEnterForegound:</td>
<td>UIApplicationWillEnterForegoundNotification</td>
<td>应用进入到前台，但是处于非活动状态会调用该方法，这个阶段可以恢复用户数据</td>
</tr>
<tr>
<td>applicationWillTerminate:</td>
<td>UIApplicationWillTerminateNotification</td>
<td>应用被终止时调用该方法并发出通知，但是内存清除除外，可以在这里释放资源 或者保存用户数据</td>
</tr>
</tbody></table>
<p>iOS应用各种状态切换的方法回调说明见下图<br><img src="http://oav23hfp9.bkt.clouddn.com/17-12-17/33791198.jpg" alt="iOS 生命周期"></p>
<h3 id="应用启动时的状态切换，对应图中的红线"><a href="#应用启动时的状态切换，对应图中的红线" class="headerlink" title="应用启动时的状态切换，对应图中的红线"></a>应用启动时的状态切换，对应图中的红线</h3><p>Not Running -&gt; Inactive -&gt; Active</p>
<h3 id="点击home键退出应用时的状态切换，对应图中的绿线"><a href="#点击home键退出应用时的状态切换，对应图中的绿线" class="headerlink" title="点击home键退出应用时的状态切换，对应图中的绿线"></a>点击home键退出应用时的状态切换，对应图中的绿线</h3><p>应用不可以后台执行时<br>Active -&gt; Inactive -&gt; Background -&gt; Suspended -&gt; Not Running</p>
<p>应用可以后台执行时<br>Active -&gt; Inactive -&gt; Background -&gt; Suspended </p>
<h3 id="挂起从新运行场景，对应图中的蓝线"><a href="#挂起从新运行场景，对应图中的蓝线" class="headerlink" title="挂起从新运行场景，对应图中的蓝线"></a>挂起从新运行场景，对应图中的蓝线</h3><p>Suspended -&gt; Background -&gt; Inactive -&gt; Active </p>
<h3 id="应用挂起后被清除时不会调用任何回调方法"><a href="#应用挂起后被清除时不会调用任何回调方法" class="headerlink" title="应用挂起后被清除时不会调用任何回调方法"></a>应用挂起后被清除时不会调用任何回调方法</h3><p>清除包括系统内存不足的系统清除 和 用户从多任务列表中清除</p>
<p>注意：</p>
<ul>
<li>应用是否可以在后台运行和挂起，由info.plist的属性Application dose not run in bakground属性决定，对应的键是UIApplicationExitsonSuspended。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2017/10/14/TinyBus-Intellij-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/14/TinyBus-Intellij-plugin/" itemprop="url">TinyBus Intellij plugin</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-14T12:12:56+08:00">
                2017-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于项目里使用到了TinyBus事件总线库，想要post方法到subscribe方法的互相导航，在网上搜索了一圈之后，找不到类似eventbus-interllij-plugin的插件，自己简单的更改了 eventbus-interllij-plugin的代码，实现了tinybus-interllij-plugin。该插件并没有修改plugin id，所以不能和eventbus-interllij-plugin同时安装，感谢eventbus-interllij-plugin作者的开源。</p>
<p>先上图</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-10-13/40809369.jpg" alt="tinybus-intellij-plugin"></p>
<p>目前只支持如下几种导航</p>
<ul>
<li><p><code>TinyBus.post</code> to <code>@Subscribe</code> or <code>onXxxEvent</code></p>
</li>
<li><p><code>TinyBus.postDelay</code> to <code>@Subscribe</code> or <code>onXxxEvent</code></p>
</li>
<li><p><code>@Subscribe</code> to <code>TinyBus.post</code></p>
</li>
<li><p>不支持<code>@Subscribe</code> to <code>TinyBus.postDelay</code></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://oav23hfp9.bkt.clouddn.com/tinybus-intellij-plugin.jar">插件下载地址</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2017/08/15/Android-6-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9D%83%E9%99%90%E5%B0%8F%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/15/Android-6-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9D%83%E9%99%90%E5%B0%8F%E8%8A%82/" itemprop="url">Android 6 运行时权限小节</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-15T21:31:00+08:00">
                2017-08-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="重大更改"><a href="#重大更改" class="headerlink" title="重大更改"></a>重大更改</h2><p>过了很久来找个Util类，发现已经找不到了，于是使用NON-UI-fragment重新实现了一遍。之前的Util需要5个步骤集成，使用了fragment之后，开箱即用。见使用方式。完整代码见最后。</p>
<ul>
<li><p>使用方式</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//初始化</span><br><span class="line">permissionHelper = PermissionHelper.attach(this);</span><br><span class="line">//申请权限</span><br><span class="line">permissionHelper.applyPermission(new String[]&#123;Manifest.permission.READ_CONTACTS&#125;, 101, new PermissionHelper.IPermissionCallback() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void onPermissionsGranted(int requestCode, String[] permissions) &#123;</span><br><span class="line">               Toast.makeText(MainActivity.this, &quot;onPermissionsGranted&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           @Override</span><br><span class="line">           public void onPermissionsDenied(int requestCode, String[] permissions) &#123;</span><br><span class="line">               Toast.makeText(MainActivity.this, &quot;onPermissionsDenied&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Android-6-运行时权限小结"><a href="#Android-6-运行时权限小结" class="headerlink" title="Android 6 运行时权限小结"></a>Android 6 运行时权限小结</h2><p>用了很多的第三方权限框架，都不是很顺手。由于最近项目里使用的框架存在一些问题，于是自己阅读了官方的文档，梳理了运行时权限相关的知识点，并形成了一个工具类供复用。</p>
<h3 id="权限的几种分类"><a href="#权限的几种分类" class="headerlink" title="权限的几种分类"></a>权限的几种分类</h3><p>在Android 6上系统将权限分为两种，一种是normal权限，另一种是dangerous权限。</p>
<p>对于normal权限 不会直接或者间接的涉及用户的隐私数据。申请这类权限直接在AndroidManifest.xml文件中声明。</p>
<p>dangerous权限，将会直接涉及到用户的隐私、敏感数据，在使用户的这类数据时，需要在程序运行时，向用户申请，只用当用户同意时才可以读取、访问用户的相关数据。</p>
<p>运行时申请的危险权限还需要在AndroidManifest.xml文件中，如果不声明的话，申请权限系统将会立刻拒绝。<br>如果使用运行时权限申请，而恰好AndroidManifest.xml文件中，一个权限都为声明，系统就会抛出错误，造成闪退，这应该是系统的一个强制性措施吧。</p>
<h4 id="权限分组"><a href="#权限分组" class="headerlink" title="权限分组"></a>权限分组</h4><pre><code>    //读写 日历
    CALENDAR = new String[]&#123;
            Manifest.permission.READ_CALENDAR,
            Manifest.permission.WRITE_CALENDAR&#125;;
    //摄像头
    CAMERA = new String[]&#123;
            Manifest.permission.CAMERA&#125;;
     // 读取联系人 写入联系人
    CONTACTS = new String[]&#123;
            Manifest.permission.READ_CONTACTS,
            Manifest.permission.WRITE_CONTACTS,
            Manifest.permission.GET_ACCOUNTS&#125;;
        //位置信息
    LOCATION = new String[]&#123;
            Manifest.permission.ACCESS_FINE_LOCATION,
            Manifest.permission.ACCESS_COARSE_LOCATION&#125;;
        //麦克风
    MICROPHONE = new String[]&#123;
            Manifest.permission.RECORD_AUDIO&#125;;
        //读取电话状态 打电话 读写通话记录 处理来电
    PHONE = new String[]&#123;
            Manifest.permission.READ_PHONE_STATE,
            Manifest.permission.CALL_PHONE,
            Manifest.permission.READ_CALL_LOG,
            Manifest.permission.WRITE_CALL_LOG,
            Manifest.permission.USE_SIP,
            Manifest.permission.PROCESS_OUTGOING_CALLS&#125;;
     // 传感器
    SENSORS = new String[]&#123;
            Manifest.permission.BODY_SENSORS&#125;;
     // 读写短信 收发短信
    SMS = new String[]&#123;
            Manifest.permission.SEND_SMS,
            Manifest.permission.RECEIVE_SMS,
            Manifest.permission.READ_SMS,
            Manifest.permission.RECEIVE_WAP_PUSH,
            Manifest.permission.RECEIVE_MMS&#125;;
    //读写存储
    STORAGE = new String[]&#123;
            Manifest.permission.READ_EXTERNAL_STORAGE,
            Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;;
</code></pre>
<h3 id="值得注意的地方"><a href="#值得注意的地方" class="headerlink" title="值得注意的地方"></a>值得注意的地方</h3><ul>
<li><p>特别需要targetSDKVersion的版本指定。当targetSDKVersion&lt;&#x3D;22时，无论程序是跑在Android 6以及高版本的手机上，还是还是 5版本的手机上，运行时权限申请都将被通过。只用targetSDKVersion&gt;&#x3D;23版本时，运行时权限才起作用。</p>
</li>
<li><p>用户上一分钟授予了某一个权限，并不代表用户这一分钟依然具有这一个权限！！！</p>
</li>
</ul>
<h3 id="Android-6-和-Android-O上的差异"><a href="#Android-6-和-Android-O上的差异" class="headerlink" title="Android 6 和 Android O上的差异"></a>Android 6 和 Android O上的差异</h3><p>在Android 6 系统版本上，如果申请了某一个组内的其中给一个权限，该组内所有的权限都被授予了程序。例如，用户授予程序READ_EXTERNAL_STORAGE 的权限，组内的WRITE_EXTERNAL_STORAGE也也一同被授予，如果程序在得到了READ_EXTERNAL_STORAGE权限之后去写入SD数据，直接写入是可行的，直到Android o，这种机制被系统推翻了。在Android O中程序程序在得到了READ_EXTERNAL_STORAGE权限之后需要往SD卡写入数据时，必须主动去申请WRITE_EXTERNAL_STORAGE<br>权限，此时，系统不会弹出让用户授权的对话框，系统将立刻授予程序该程序，如果不申请权限直接就写入的话，系统会抛出异常。</p>
<h3 id="Util类的使用"><a href="#Util类的使用" class="headerlink" title="Util类的使用"></a>Util类的使用</h3><h4 id="step-0"><a href="#step-0" class="headerlink" title="step 0"></a>step 0</h4><p>需要Activity 或者fragment实现util类中的回调PermissionCallback</p>
<pre><code> interface PermissionCallback &#123;
    //用户授予了所有的权限
    void onPermissionsGranted(int requestCode, String permissions[]);
    //用户拒绝了权限申请
    void onPermissionsDenied(int requestCode, String permissions[]);

&#125;
</code></pre>
<h4 id="step-1"><a href="#step-1" class="headerlink" title="step 1"></a>step 1</h4><p>检查是否需要向用户解释为什么需要申请该权限，只有当这个权限被用户拒绝授予过，而且未勾选“不再询问”的复选框时，该方法的返回值才会为true</p>
<pre><code>PermissionCompat.shouldShowRequestPermissionRationale(
    this，
    PermissionCompat.STORAGE）
</code></pre>
<h4 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h4><p>当上一个步骤的返回值为true时，表明用户已经拒绝授予某个权限，且未勾选不在询问的复选框，此时程序需要向用户解释说明为什么需要这个权限，例如，向用户弹个框解释，当用户点击了确定按钮时，去申请去权限。<br>如果上一个步骤的返回值为false，则可以直接去申请权限</p>
<pre><code>PermissionCompat.requestPermissions(this, requestCode,PermissionCompat.STORAGE);
</code></pre>
<h4 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h4><p>实现Activity 或者fragment的onRequestPermissionsResult方法，并使用Util类中的方法分发返回结果。</p>
<pre><code>@Override
public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) &#123;
    super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    PermissionCompat.onRequestPermissionsResult(this,requestCode,permissions,grantResults);
&#125;
</code></pre>
<h4 id="step-4"><a href="#step-4" class="headerlink" title="step 4"></a>step 4</h4><ul>
<li><p>当用户授予了权限时，在PermissionCallback的onPermissionsGranted回调方法中处理要做的工作。</p>
</li>
<li><p>当用户拒绝了某一个权限授予时，会回调PermissionCallback的onPermissionsDenied方法，可以在这个方法中检测，用户是否勾选了“不再询问”的复选框，如果用户勾选了，需要向用户解释需要改权限的理由，同时引导用户跳转到《设置》下的应用程序权限设置，给用户一个设置再次开启权限的入口。例如弹个框，当用户点击确定按钮时，跳转到用程序权限设置界面。</p>
<pre><code>PermissionCompat.showAppSetting(MainActivity.this,requestCode);
</code></pre>
</li>
</ul>
<h4 id="step-5"><a href="#step-5" class="headerlink" title="step 5"></a>step 5</h4><p>在Activity 或者fragment的onActivityResult方法回调用处理应用权限的开启情况。 </p>
<p>需要注意的是，当用户在应用的权限设置界面打开某一个程序之后跳转到当前应用程序时（一直按返回键）会直接回调到onActivityResult，如果存在用户关闭某一个权限的情况下，再跳转回当前应用程序时（一直按返回键），会先导致当前应用的Activity重启，最后依然会回调到onActivityResult方法。</p>
<p>  demo地址</p>
<h2 id="最新版本代码："><a href="#最新版本代码：" class="headerlink" title="最新版本代码："></a>最新版本代码：</h2><pre><code>public class PermissionHelper extends Fragment &#123;

private static final String FRAG_TAG = PermissionHelper.class.getCanonicalName();

public static final String[] CALENDAR, CAMERA, CONTACTS, LOCATION, MICROPHONE, PHONE, SENSORS, SMS, STORAGE;

static &#123;
    //读写 日历
    CALENDAR = new String[]&#123;
            Manifest.permission.READ_CALENDAR,
            Manifest.permission.WRITE_CALENDAR&#125;;
    //摄像头
    CAMERA = new String[]&#123;
            Manifest.permission.CAMERA&#125;;
    // 读取联系人 写入联系人
    CONTACTS = new String[]&#123;
            Manifest.permission.READ_CONTACTS,
            Manifest.permission.WRITE_CONTACTS,
            Manifest.permission.GET_ACCOUNTS&#125;;
    //位置信息
    LOCATION = new String[]&#123;
            Manifest.permission.ACCESS_FINE_LOCATION,
            Manifest.permission.ACCESS_COARSE_LOCATION&#125;;
    //麦克风
    MICROPHONE = new String[]&#123;
            Manifest.permission.RECORD_AUDIO&#125;;
    //读取电话状态 打电话 读写通话记录 处理来电
    PHONE = new String[]&#123;
            Manifest.permission.READ_PHONE_STATE,
            Manifest.permission.CALL_PHONE,
            Manifest.permission.READ_CALL_LOG,
            Manifest.permission.WRITE_CALL_LOG,
            Manifest.permission.USE_SIP,
            Manifest.permission.PROCESS_OUTGOING_CALLS&#125;;
    // 传感器
    SENSORS = new String[]&#123;
            Manifest.permission.BODY_SENSORS&#125;;
    // 读写短信 收发短信
    SMS = new String[]&#123;
            Manifest.permission.SEND_SMS,
            Manifest.permission.RECEIVE_SMS,
            Manifest.permission.READ_SMS,
            Manifest.permission.RECEIVE_WAP_PUSH,
            Manifest.permission.RECEIVE_MMS&#125;;
    //读写存储
    STORAGE = new String[]&#123;
            Manifest.permission.READ_EXTERNAL_STORAGE,
            Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;;
&#125;

private Activity mContext;

private int mRequestCode;
private IPermissionCallback mPermissionListener;


public static &lt;ParentFrag extends Fragment &gt; PermissionHelper attach(ParentFrag parent) &#123;
    return attach(parent.getChildFragmentManager());
&#125;

public static &lt;ParentActivity extends FragmentActivity &gt; PermissionHelper attach(ParentActivity parent) &#123;
    return attach(parent.getSupportFragmentManager());
&#125;

private static PermissionHelper attach(FragmentManager fragmentManager) &#123;
    PermissionHelper frag = (PermissionHelper) fragmentManager.findFragmentByTag(FRAG_TAG);
    if (frag == null) &#123;
        frag = new PermissionHelper();
        fragmentManager.beginTransaction().add(frag, FRAG_TAG).commit();
        //fragment在Activity的onreate中被attach之后就立即调用fragment的一些方法，需要如下代码，否则不需要
        fragmentManager.executePendingTransactions();
    &#125;
    return frag;
&#125;


protected IPermissionCallback getParent() &#123;
    Fragment parentFragment = getParentFragment();
    if (parentFragment instanceof IPermissionCallback) &#123;
        return (IPermissionCallback) parentFragment;
    &#125; else &#123;
        Activity activity = getActivity();
        if (activity instanceof IPermissionCallback) &#123;
            return (IPermissionCallback) activity;
        &#125;
    &#125;
    return null;
&#125;

public void applyPermission(final String[] permissions, final int requestCode, final IPermissionCallback listener) &#123;

    //版本检测
    if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.M) &#123;
        listener.onPermissionsGranted(requestCode, permissions);
        return;
    &#125;

    //被拒的权限
    final List&lt;String&gt; deniedPermissions = findDeniedPermissions(permissions);

    if (deniedPermissions.size() == 0) &#123;
        listener.onPermissionsGranted(requestCode, permissions);
        return;
    &#125;
    this.mRequestCode = requestCode;
    this.mPermissionListener = listener;

    //需要解释
    List&lt;String&gt; rationalePermissions = hasShowRequestPermissionRationale(permissions);
    if (rationalePermissions.size() == 0) &#123;
        requestPermissions(deniedPermissions.toArray(new String[deniedPermissions.size()]), requestCode);
    &#125; else &#123;
        // TODO: 被用户拒绝过但是没有勾选再也不提示的checkbox，需要向用户解释说明为什么需要权限
        AlertDialog dialog = new AlertDialog.Builder(mContext).setTitle(&quot;权限申请提示&quot;).setMessage(&quot;需要使用权限才能正常使用，是否授权？&quot;)
                .setNegativeButton(&quot;cancle&quot;, new DialogInterface.OnClickListener() &#123;
                    @Override
                    public void onClick(DialogInterface dialog, int which) &#123;
                        if (mPermissionListener != null) &#123;
                            mPermissionListener.onPermissionsDenied(requestCode, permissions);
                        &#125;
                    &#125;
                &#125;)
                .setPositiveButton(&quot;confirm&quot;, new DialogInterface.OnClickListener() &#123;
                    @Override
                    public void onClick(DialogInterface dialog, int which) &#123;

                        requestPermissions(deniedPermissions.toArray(new String[deniedPermissions.size()]), requestCode);
                    &#125;
                &#125;).create();

        dialog.show();

    &#125;



&#125;

private List&lt;String&gt; hasShowRequestPermissionRationale(String... permission) &#123;
    List&lt;String&gt; rationalePermissions = new ArrayList&lt;&gt;();
    for (String value : permission) &#123;
        if (shouldShowRequestPermissionRationale(value)) &#123;
            rationalePermissions.add(value);
        &#125;
    &#125;
    return rationalePermissions;
&#125;

private List&lt;String&gt; findDeniedPermissions(String... permission) &#123;
    List&lt;String&gt; denyPermissions = new ArrayList&lt;&gt;();
    for (String value : permission) &#123;
        if (ContextCompat.checkSelfPermission(mContext, value) != PackageManager.PERMISSION_GRANTED) &#123;
            denyPermissions.add(value);
        &#125;
    &#125;
    return denyPermissions;
&#125;

@Override
public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) &#123;
    if (requestCode == this.mRequestCode) &#123;
        List&lt;String&gt; grantPermissions = new ArrayList&lt;&gt;();
        List&lt;String&gt; deniedPermissions = new ArrayList&lt;&gt;();

        for (int i = 0; i &lt; grantResults.length; i++) &#123;
            if (grantResults[i] != PackageManager.PERMISSION_GRANTED) &#123;
                deniedPermissions.add(permissions[i]);
            &#125; else &#123;
                grantPermissions.add(permissions[i]);
            &#125;
        &#125;
        if (deniedPermissions.size() == 0) &#123;
            if (mPermissionListener != null) &#123;
                mPermissionListener.onPermissionsGranted(requestCode, grantPermissions.toArray(new String[grantPermissions.size()]));
            &#125;
        &#125; else &#123;
            if (mPermissionListener != null) &#123;
                mPermissionListener.onPermissionsDenied(requestCode, deniedPermissions.toArray(new String[deniedPermissions.size()]));
            &#125;
        &#125;
    &#125;


&#125;

@Override
public void onAttach(Context context) &#123;
    super.onAttach(context);
    mContext = (Activity) context;
&#125;

@Override
public void onDetach() &#123;
    super.onDetach();
    mContext = null;
    mPermissionListener = null;
&#125;

public interface IPermissionCallback &#123;
    //授予了所有的权限
    void onPermissionsGranted(int requestCode, String permissions[]);

    //拒绝的权限 考虑再该回调中指引用户打开系统设置界面，引导用户打开权限
    void onPermissionsDenied(int requestCode, String permissions[]);
&#125;

&#125;


    

    
    
        

        
    
</code></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2017/07/09/Android%E5%BC%82%E6%AD%A5%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%E5%B0%8F%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/09/Android%E5%BC%82%E6%AD%A5%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%E5%B0%8F%E8%8A%82/" itemprop="url">Android异步消息通信小节</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-09T22:05:35+08:00">
                2017-07-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>试着从整体的角度上去简述Handler、Looper、MessageQueue<br>三者之间的关系，以及使用这三者构建的Android系统的异步消息通信机制。</p>
<p>三者之间的关系,一图胜千言。</p>
<p><img src="http://image.lxway.com/upload/1/36/136c06769c6d0a67f1f05d6fc8e504ac.png" alt="Handler与Looper与MessageQueue的关系"></p>
<p>一些术语：</p>
<ul>
<li>Message : 线程间通信的消息载体，存储于MessageQueue中。</li>
<li>MessageQueue : 负责存储Message对象，每个线程只能关联一个MessageQueue。</li>
<li>Looper :无限消息循环，不停的检索MessageQueue，每个线程只能关联一个Looper。</li>
<li>Handler：负责消息的分发（将message添加到MessageQueue中）和处理。每个线程可以关联多个Handler。</li>
</ul>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Android 应用初始化的时候，会创建一个主线，通常称为Main Thread,亦或是UI线程。在UI线程的初始化过程中，会创建一个Looper， 同时将此Looper与UI线程绑定，该Looper负责管理应用程序对象包括Activity、以及Activity的window、BroadcastReciver等的通信，一个线程只会有一个Looper实例。</p>
<p>在Looper实例的创建过程中，又会创建一个MessageQueue对象。MessageQueue 负责存储Message，但是Message的添加不是直接通过MessageQueue，而是通过与Looper对象的相关联的Handler。<br>MessageQueue是消息存储的场所，</p>
<p>Looper无线循环的检索MessageQueue中是否有需要处理的消息，检索到有message时，执行message的target(即Handler)的dispatchMessage方法。</p>
<p>Handler对象在创建时，默认会关联到创建它的当前线程以及当前线程的MessageQueue。默认的线程是不具有Looper以及MessageQueue对象的。使用Handler对象可以将Message和runnable投递到与当前线程相关联的MessageQueue中，同时，可以在message出栈的时候对其进行处理。</p>
<h3 id="Handler的两个主要作用"><a href="#Handler的两个主要作用" class="headerlink" title="Handler的两个主要作用"></a>Handler的两个主要作用</h3><ul>
<li><p>a. 安排在将来的某个时间点执行message或者runnable。</p>
</li>
<li><p>b. 跨线程通信，可以通过其实现子线程和UI线程之间的通信。</p>
</li>
</ul>
<h3 id="在子线程更新UI的几种方式"><a href="#在子线程更新UI的几种方式" class="headerlink" title="在子线程更新UI的几种方式"></a>在子线程更新UI的几种方式</h3><ul>
<li>a. 使用Handler的send or post 系列的方法。</li>
<li>b. 在Activity 中使用runUiOnThread(runnable)方法</li>
<li>c. 使用View.post(runnable)方法</li>
</ul>
<h3 id="一些值得注意的地方"><a href="#一些值得注意的地方" class="headerlink" title="一些值得注意的地方"></a>一些值得注意的地方</h3><ul>
<li>a. 如果想要在自己创建的Thread中使用Looper，可以使用系统提供的HandlerThread类。</li>
<li>b. 慎用Handler，Handler过长的生命周期会一直持有Activity，造成内存泄露。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://yndongyong.github.io/2017/07/05/Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%B0%8F%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yndongyong‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/05/Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%B0%8F%E8%8A%82/" itemprop="url">Activity生命周期小节</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-05T22:03:42+08:00">
                2017-07-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Activity被设计用来与用户进行交互，界面元素的展示、交互动效、业务逻辑等都将在这里依赖业务逻辑以及其间的关系进行编码。<br>Activity是整个应用生命周期的重要组成部分。所有的activity都会被 Activity Stack进行管理，当一个新的Activity被启动，它将会被系统放入Activity Stack 并且处于栈顶，而之前的Activity依然停留在Activity Stack中，处于新的Activity之下。</p>
<h3 id="Activity的几种状态"><a href="#Activity的几种状态" class="headerlink" title="Activity的几种状态"></a>Activity的几种状态</h3><ul>
<li>running  Activity对用户可见，处于屏幕的最前，即Activity Stack的栈顶</li>
<li>paused  当前Activity被dialog和或者非全屏的Activity覆盖，此时，Activity对于用户可能可见，且不再具有与用户交互的能力。</li>
<li>stopped 另一个Activity来到了前台，当前的Activity完全被覆盖对用户不可见。</li>
<li>destroyed Activity处于 paused或者stopped状态时被系统回收了。</li>
</ul>
<h3 id="Activity向开发者提供了一整个完整的生命周期hook函数"><a href="#Activity向开发者提供了一整个完整的生命周期hook函数" class="headerlink" title="Activity向开发者提供了一整个完整的生命周期hook函数"></a>Activity向开发者提供了一整个完整的生命周期hook函数</h3><p> <img src="http://ww1.sinaimg.cn/mw690/a0b1fa45gy1fha7psnvraj20e90ifmz4.jpg" alt="Activity生命周期图"></p>
<p>onCreate(bundle) -&gt; onStart() -&gt; onResume() -&gt; onPause() -&gt;onStop() -&gt; onDestroy()</p>
<p>可见的生命周期：onStart() 与onStop() 两个函数调用之前的这段时间，Activity对于用户是可见的。</p>
<p>前台生命周期：onResume() 与 onPause() 两个函数发生调用的这段时间内，Activity是处于<strong>前台</strong>的。</p>
<ul>
<li><p>onCreate() 所有的Activity对需要实现onCreate(bundle)方法，在这里为window 设置ui，绑定数据。</p>
</li>
<li><p>onStart ()  Activity 即将进入前台被用户可见。</p>
</li>
<li><p>onResume()  Activiy进入前台且能够与用户交互。</p>
</li>
<li><p>onPause()  系统开始调用另一个Activity的生命周期；可以在在这里进行数据的保存，持久化，停止动画，释放CPU资源等的轻量级操作。<strong>只有当这个方法放回之后系统才会调用另一个Activity的生命周期</strong>，所以请不要在该方法里执行耗时的操作，以避免造成UI卡顿。</p>
</li>
<li><p>onStop()  Activity 不在被用户可见，新的Activity已经处于running状态，可以在这里了持久化一些数据，释放内存资源。</p>
</li>
<li><p>onDestroy() Activity 进入了destroyed的状态 ，被调用了finish方法或者被系统回收内存而被清理。</p>
</li>
<li><p>onRestart() Activity 进入stopped 状态时，重新被带入前台。</p>
<p>在实现这些生命周期hook函数时，<strong>总是需要调用父类的方法</strong>。</p>
<p>​</p>
</li>
</ul>
<h3 id="各种情况下Activity生命周期的调用顺序"><a href="#各种情况下Activity生命周期的调用顺序" class="headerlink" title="各种情况下Activity生命周期的调用顺序###"></a>各种情况下Activity生命周期的调用顺序###</h3><ul>
<li><p>当Activity被启动时各个生命周期方法的调用顺序</p>
<p> <img src="http://oav23hfp9.bkt.clouddn.com/act%E8%A2%AB%E6%89%93%E5%BC%80%E6%97%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="启动Activity"></p>
</li>
<li><p>当Activity处于running状态按下返回键时</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/act%E6%8C%89%E8%BF%94%E5%9B%9E%E9%94%AE.png" alt="按下返回键"></p>
</li>
<li><p>当Activity处于running状态按下Home键时</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/act%E6%8C%89%E4%B8%8Bhome%E9%94%AE.png" alt="按下Home键时"></p>
</li>
<li><p>从多任务切换器切换时</p>
<p> <img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/%E6%8C%89%E4%B8%8BHome%E9%94%AE%EF%BC%8C%E4%BB%8E%E5%A4%9A%E4%BB%BB%E5%8A%A1%E5%88%87%E6%8D%A2%E5%9B%9E.png"></p>
</li>
<li><p>当Activity处于running状态切换到另一个Activity时</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/%E5%88%87%E6%8D%A2%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AAact.png"></p>
</li>
<li><p>从另一个Activity切换回时</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/%E4%BB%8E%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AA%E5%88%87%E5%9B%9E%E6%97%B6.png"></p>
</li>
<li><p>按下锁屏键</p>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/act%E6%8C%89%E4%B8%8Bhome%E9%94%AE.png" alt="按下Home键时"></p>
</li>
<li><p>解锁时</p>
</li>
</ul>
<p><img src="http://oav23hfp9.bkt.clouddn.com/17-7-6/%E6%8C%89%E4%B8%8BHome%E9%94%AE%EF%BC%8C%E4%BB%8E%E5%A4%9A%E4%BB%BB%E5%8A%A1%E5%88%87%E6%8D%A2%E5%9B%9E.png"></p>
<h3 id="Configuration-changes-对生命周期的影响"><a href="#Configuration-changes-对生命周期的影响" class="headerlink" title="Configuration changes 对生命周期的影响"></a>Configuration changes 对生命周期的影响</h3><p>设备的configuration 发生改变时，都会最先通知到Activity处，系统会将Activity执行destroy操作，然后重新激活Activity，会重走一遍生命周期。</p>
<p>在新的系统版本里，由竖屏切换到横屏，或者横屏切换到竖屏都只会重走一遍生命周期，这个时候空间的一些状态会被保存，重走生命周期的时候状态会被恢复，但是用户的输入等数据不会被系统保存，需要开发者自己处理。</p>
<p>有些时候需要我们绕过重走生命周期的流程，Manifest文件中，为Activity配置属性：android:configChanges;可以为该属性指定很多种值，已达到当这些值对应的情况改变打的时候，不重走生命周期，而是回调到Activity的onConfigurationChanged方法。</p>
<p>以下配置可以达到<strong>横竖屏切换时，不重启Activity</strong>的效果：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:configChanges=<span class="string">&quot;orientation|keyboardHidden|screenSize&quot;</span></span><br></pre></td></tr></table></figure>



          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yndongyong</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

</body>
</html>
